<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ applicant.first_name }} {{ applicant.last_name }}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/employer.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='Assets/PESO_logo.png') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/employer.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/loader.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/report-modal.css') }}"
    />
  </head>
  <body
    data-report-url="{{ url_for('employers.report_applicant', applicant_id=applicant.applicant_id) }}"
  >
    <header class="header">
      <div class="container">
        <div class="logo">
          <img
            src="{{ url_for('static', filename='Assets/PESO_logo.png') }}"
            alt="PESO SmartHire Logo"
          />
        </div>
        <nav class="nav">
          <a
            href="{{url_for('employers.employer_home')}}"
            class="nav-link-active"
            >Home</a
          >
          <a
            href="{{url_for('employers.application_management')}}"
            class="nav-link"
            >Job Applications</a
          >
          <a href="{{url_for('employers.notifications')}}" class="nav-link"
            >Notification
            <span
              id="employerNotifBadge"
              class="notif-badge"
              style="display: none"
              >●</span
            ></a
          >
          <a href="{{url_for('employers.account_security')}}" class="nav-link"
            >Account & Security</a
          >
          <a href="{{url_for('logout')}}" id="logoutLink" class="nav-link"
            >Log Out</a
          >
        </nav>
      </div>
    </header>

    <section class="hero">
      <div class="hero-background">
        <img
          src="{{ url_for('static', filename='Assets/background.png') }}"
          alt="New City Hall of Lipa CIty"
        />
      </div>
      <div class="hero-content">
        <div class="container">
          <h1 class="hero-title">
            Welcome{% if session.employer_name %}, {{ session.employer_name }}{%
            endif %}!
          </h1>
          <!-- You can add the employer's name here using python-->
          <p class="hero-description">Here's what we have today</p>
        </div>
      </div>
    </section>

    <section class="account-and-security">
      <div class="container">
        <div class="left">
          <div class="back-button" style="margin: 12px 0">
            <a href="javascript:void(0);" onclick="window.history.back();"
              ><i class="fa-solid fa-arrow-left"></i
            ></a>
          </div>
        </div>
        <!--<div class="right">
          <i class="fa-solid fa-bars" id="menuToggle"></i>
          <div class="dropdown-menu" id="dropdownMenu">
            <a href="#" id="reportAccountBtn" data-report-applicant-trigger>Report Applicant</a>
          </div>
        </div>-->
      </div>
    </section>

    <div class="profile-container">
      <div class="container">
        <div class="profile-header">
          <div class="profile-pic">
            {% if applicant.profile_pic_path %}
            <img
              src="{{ url_for('static', filename=applicant.profile_pic_path) }}"
              alt="Profile Picture"
            />
            {% else %}
            <img
              src="{{ url_for('static', filename='Assets/default-avatar.png') }}"
              alt="Default Profile"
            />
            {% endif %}
          </div>
          <div class="profile-details">
            <h2>
              {{ applicant.first_name }} {% if applicant.middle_name %}{{
              applicant.middle_name }} {% endif %}{{ applicant.last_name }}
            </h2>
            <p>
              <strong>Applicant Code:</strong> {{ applicant.applicant_code or
              'N/A' }}
            </p>
            <p><strong>Status:</strong> {{ applicant.status or 'N/A' }}</p>
          </div>
          <div class="profile-actions">
            {% set context_options = namespace(items=[{'value': '', 'label':
            'Not tied to a specific job'}]) %} {% for app in applications %} {%
            set _ = context_options.items.append({'value': app.job_id, 'label':
            app.job_position or ('Job ID ' ~ app.job_id)}) %} {% endfor %}
            <button
              type="button"
              class="report-account-chip"
              data-report-trigger
              data-report-endpoint="{{ url_for('employers.report_applicant', applicant_id=applicant.applicant_id) }}"
              data-report-title="Report Applicant"
              data-report-helper="Explain why this applicant should be reviewed. Your note goes directly to the admin team."
              data-report-type="applicant"
              data-reported-id="{{ applicant.applicant_id }}"
              data-report-context-options="{{ context_options.items|tojson }}"
              data-report-context-label="Related job posting"
              data-report-context-field="job_id"
              data-report-min-length="10"
              data-report-success="Thanks! We'll review this applicant soon."
            >
              <i class="fa-solid fa-flag"></i> Report Applicant
            </button>
          </div>
        </div>

        <div class="section">
          <h3>Personal Information</h3>
          <p><strong>Age:</strong> {{ applicant.age or 'N/A' }}</p>
          <p><strong>Sex:</strong> {{ applicant.sex or 'N/A' }}</p>
          <p><strong>Phone:</strong> {{ applicant.phone or 'N/A' }}</p>
          <p><strong>Email:</strong> {{ applicant.email or 'N/A' }}</p>
        </div>

        <div class="section">
          <h3>Address</h3>
          <p><strong>Province:</strong> {{ applicant.province or 'N/A' }}</p>
          <p><strong>City:</strong> {{ applicant.city or 'N/A' }}</p>
          <p><strong>Barangay:</strong> {{ applicant.barangay or 'N/A' }}</p>
        </div>

        <div class="section">
          <h3>Education</h3>
          <p>{{ applicant.education or 'N/A' }}</p>
        </div>

        {% if applicant.is_pwd %}
        <div class="section">
          <h3>Person with Disability</h3>
          <p><strong>Type:</strong> {{ applicant.pwd_type or 'N/A' }}</p>
        </div>
        {% endif %} {% if applicant.has_work_exp %}
        <div class="section">
          <h3>Work Experience</h3>
          <p>
            <strong>Years of Experience:</strong> {{ applicant.years_experience
            or 'N/A' }}
          </p>
        </div>
        {% endif %}

        <div class="section">
          <h3>Reason for Registering</h3>
          <p>{{ applicant.registration_reason or 'N/A' }}</p>
        </div>

        <div class="section documents">
          <h3>Documents</h3>
          <ul>
            {% if applicant.resume_path %}
            <li>
              <a
                href="{{ url_for('static', filename=applicant.resume_path) }}"
                target="_blank"
                >Resume</a
              >
            </li>
            {% endif %} {% if not applicant.is_from_lipa and
            applicant.recommendation_letter_path %}
            <li>
              <a
                href="{{ url_for('static', filename=applicant.recommendation_letter_path) }}"
                target="_blank"
                >Recommendation Letter</a
              >
            </li>
            {% endif %}
          </ul>
        </div>

        <div class="section">
          <h3>System Info</h3>
          <p><strong>Registered At:</strong> {{ applicant.created_at }}</p>
          <p><strong>Updated At:</strong> {{ applicant.updated_at }}</p>
        </div>

        <!-- Employer: Applications list with per-application status control -->
        <div class="section">
          <h3>Applications</h3>
          {% if not applications or applications|length == 0 %}
          <p class="empty-msg">No application records found.</p>
          {% else %}
          <div class="applications-list">
            {% for app in applications %}
            <!-- Added data-app-id for modal functionality -->
            <div
              class="application-row"
              data-job-id="{{ app.job_id }}"
              data-app-id="{{ app.id }}"
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-top: 8px;
                "
              >
                <strong
                  >{{ app.job_position or ('Job ID: ' ~ app.job_id) }}</strong
                >
                <span>
                  <strong id="status-{{ app.id }}"
                    >{{ app.status or 'Pending' }}</strong
                  ></span
                >
              </div>

              <div style="margin-top: 8px">
                <div>
                  <small
                    >Applied at: {{ app.applied_at.strftime('%m/%d/%Y %I:%M %p')
                    }}</small
                  >
                </div>
                <!-- Replaced dropdown with Edit Status button -->
                <br />
                <button class="edit-status-btn" data-app-id="{{ app.id }}">
                  <i class="fa-solid fa-pencil"></i> Edit Status
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div id="statusModal" class="status-modal" style="display: none">
      <div class="status-modal-content">
        <div class="status-modal-header">
          <h3>Update Application Status</h3>
          <button class="status-modal-close" id="closeStatusModal">
            &times;
          </button>
        </div>
        <div class="status-modal-body">
          <p>Select the new status for this application:</p>
          <div class="status-options">
            <button class="status-option-btn" data-status="Pending">
              <i class="fa-solid fa-hourglass-end"></i>
              <span>Pending</span>
            </button>
            <button class="status-option-btn" data-status="Shortlisted">
              <i class="fa-solid fa-star"></i>
              <span>Shortlisted</span>
            </button>
            <button class="status-option-btn" data-status="For Interview">
              <i class="fa-solid fa-calendar"></i>
              <span>For Interview</span>
            </button>
            <button class="status-option-btn" data-status="Hired">
              <i class="fa-solid fa-check-circle"></i>
              <span>Hired</span>
            </button>
            <button class="status-option-btn" data-status="Rejected">
              <i class="fa-solid fa-times-circle"></i>
              <span>Rejected</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);
        const filterJobId = params.get("job_id");

        if (filterJobId) {
          const rows = document.querySelectorAll(".application-row");
          let visibleCount = 0;

          rows.forEach((row) => {
            if (row.dataset.jobId !== filterJobId) {
              row.style.display = "none";
            } else {
              row.style.display = "block";
              row.style.border = "1px solid #d0d7de";
              row.style.backgroundColor = "white";
              row.style.borderRadius = "10px";
              row.style.padding = "20px";
              row.style.transition = "0.2s ease";
              row.style.boxShadow = "0 2px 6px rgba(0,0,0,0.08)";
              visibleCount++;
            }
          });
        }
      });

      document.addEventListener("change", async (e) => {
        const sel = e.target.closest(".status-select");
        if (!sel) return;
        const appId = sel.dataset.appId;
        const newStatus = sel.value;
        try {
          const res = await fetch(
            `/employers/api/applications/${appId}/status`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: newStatus }),
            }
          );
          const data = await res.json();
          if (data.success) {
            document.getElementById(`status-${appId}`).textContent =
              data.new_status;
          } else {
            alert(data.message || "Failed to update status");
          }
        } catch (err) {
          console.error(err);
          alert("Error updating status");
        }
      });

      let currentApplicationId = null;

      // Open modal when Edit Status button is clicked
      document.addEventListener("click", function (e) {
        const editBtn = e.target.closest(".edit-status-btn");
        if (editBtn) {
          currentApplicationId = editBtn.dataset.appId;
          document.getElementById("statusModal").style.display = "flex";
        }
      });

      // Close modal
      document
        .getElementById("closeStatusModal")
        .addEventListener("click", function () {
          document.getElementById("statusModal").style.display = "none";
          currentApplicationId = null;
        });

      // Close modal when clicking outside
      document
        .getElementById("statusModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            this.style.display = "none";
            currentApplicationId = null;
          }
        });

      // Handle status option selection
      document.addEventListener("click", async function (e) {
        const statusBtn = e.target.closest(".status-option-btn");
        if (!statusBtn || !currentApplicationId) return;

        const newStatus = statusBtn.dataset.status;

        try {
          const res = await fetch(
            `/employers/api/applications/${currentApplicationId}/status`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: newStatus }),
            }
          );
          const data = await res.json();
          if (data.success) {
            document.getElementById(
              `status-${currentApplicationId}`
            ).textContent = data.new_status;
            document.getElementById("statusModal").style.display = "none";
            currentApplicationId = null;
            // Optional: Show success message
            alert(
              "Status updated successfully and applicant has been notified!"
            );
          } else {
            alert(data.message || "Failed to update status");
          }
        } catch (err) {
          console.error(err);
          alert("Error updating status");
        }
      });
    </script>

    {% include 'partials/report_modal.html' %}
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-left">
            <h3>PESO SmartHire</h3>
            <p>
              Connecting talent with opportunity through innovative recruitment
              solutions.
            </p>
            <a href="{{ url_for('terms_and_conditions') }}" class="footer-note"
              >Terms and Conditions</a
            >
            <p class="copyright">© 2025 PESO SmartHire. All rights reserved.</p>
          </div>
          <div class="footer-right">
            <h3>Development Team</h3>
            <div class="team-member">
              <span>Anoya, Ruffa F.</span>
              <div class="social-links">
                <a href="https://github.com/anoyaruffa" target="_blank"
                  ><i class="devicon-github-plain"></i
                ></a>
                <a href="#"><i class="devicon-facebook-plain"></i></a>
                <a href="mailto:ruffaanoya2005@gmail.com" target="_blank"
                  ><i class="fa-solid fa-envelope"></i
                ></a>
              </div>
            </div>
            <div class="team-member">
              <span>Levita, Reymark A.</span>
              <div class="social-links">
                <a href="https://github.com/elliwinx" target="_blank"
                  ><i class="devicon-github-plain"></i
                ></a>
                <a
                  href="https://www.facebook.com/reymark.levita.3"
                  target="_blank"
                  ><i class="devicon-facebook-plain"></i
                ></a>
                <a href="mailto:levitareymark11@gmail.com" target="_blank"
                  ><i class="fa-solid fa-envelope"></i
                ></a>
              </div>
            </div>
            <div class="team-member">
              <span>Samonte, Ralph Matthew A.</span>
              <div class="social-links">
                <a href="https://github.com/RalphWreckeri2" target="_blank"
                  ><i class="devicon-github-plain"></i
                ></a>
                <a
                  href="https://www.facebook.com/ralphmatthew.13"
                  target="_blank"
                  ><i class="devicon-facebook-plain"></i
                ></a>
                <a href="mailto:ralphmatthew.samonte@gmail.com" target="_blank"
                  ><i class="fa-solid fa-envelope"></i
                ></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <!-- Global loader partial -->
    {% include 'partials/loader.html' %}
    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/logout.js') }}"></script>
    <script src="{{ url_for('static', filename='js/report-modal.js') }}"></script>
  </body>
</html>
